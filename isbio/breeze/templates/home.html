{% extends "base.html" %}

{% load bootstrap_toolkit %}

{% block title %}Home{% endblock %}

{% block extra_head %}

  <script type="text/javascript" src="/static/js/bootstrap-multiselect.js"></script>
  <link rel="stylesheet" href="/static/css/bootstrap-multiselect.css" type="text/css"/>
  <script type="text/javascript" src="/static/js/bootstrap-paginator.min.js"></script>

  <style>
    .thumbnails .span4:nth-child(3n+1) {
  margin-left:0;
  }

  .widget .panel-body { padding: 0px; }
  .widget .list-group { margin-bottom: 0; }
  .widget .panel-title { display:inline }
  .widget ul { list-style-type: none; }
  .widget li.list-group-item {border-radius: 0;border: 0;border-top: 1px solid #ddd; margin-bottom: 15px; }
  .widget li.list-group-item:hover { background-color: rgba(86,61,124,.1); }
  .widget .mic-info { color: #666666;font-size: 11px; }
  .widget .comment-text { font-size: 12px; }

  .modal { overflow: visible; }
  .modal-body { overflow-y: visible; }
  </style>

{% endblock %}

{% block content %}
<div class="row-fluid">
  &nbsp;
</div>

<div class="row-fluid">
  <!-- USER INFO -->
  <div class="span3  offset1 ">
    <div class="row-fluid">
      <div class="span12 well">
        <img style="float: left; margin: 1px 11px 1px 19px; height: 72px; width: 72px;" src="/static/user.jpg" class="thumbnail img-rounded">
        <p> <strong>Welcome:</strong> </p>
        <p>@{{ user.username|default:"USER NAME" }} </br>
        <strong> {{ user.first_name|default:"FirtstN" }} {{ user.last_name|default:"LastN" }} </strong></p> </br>
        <a id="update_btn" href="#" data-toggle="modal" class="btn btn-mini btn-primary btn-block hcalls" data-target="#UpdateInfo"  data-param="/update-user-info/">
          Update Info
        </a>
      </div>
    </div>
    <!-- DASH -->
    <div class="row-fluid">
      <div class="span12 well">
        <ul class="nav nav-list">
          <li class="{{ feed_menu }}"><a href="#feed_menu" data-toggle="tab"><strong>Feed</strong></a></li>
          <li class="{{ explorer_menu }}"><a href="#explorer_menu" data-toggle="tab"><strong>DB Explorer</strong></a></li>
          <li class="{{ preferences_menu }}"><a href="#preferences_menu" data-toggle="tab"><strong>Preferences</strong></a></li>
        </ul>
      </div>
    </div>

    <div class="row-fluid">
      <div class="span12 well">
        <a href="/scripts" class="btn btn-large btn-block btn-primary" type="button">
          <strong><i class="icon-tasks icon-white"></i> &nbsp;Start New Job</strong>
        </a>
        <a href="/reports" class="btn btn-large btn-block btn-primary" type="button">
          <strong><i class="icon-th icon-white"></i> &nbsp;Build New Report</strong>
        </a>
        <a href="/help" class="btn btn-large btn-block btn-primary" type="button">
          <strong><i class="icon-question-sign icon-white"></i> &nbsp;How To Use BREEZE</strong>
        </a>
      </div>
    </div>
  </div>

  <div class="span7">
    <div class="tab-content">
      <!-- FEED -->
      <div class="tab-pane {{ show_feed }}" id="feed_menu">
        <div class="row-fluid">
          <div class="span 12">
            <div class="panel panel-default widget">
              <div class="panel-body">
                <ul class="list-group">
                  {% for post in posts %}
                  <li class="list-group-item">
                    <i class="icon-comment"></i>&nbsp;
                    <a href="#">
                      {{ post.title }}
                    </a>
                    <div class="mic-info">
                      By: <a href="#">{{ post.author }}</a> {{ post.time }}
                    </div>
                    <div class="comment-text">{{ post.body }}</div>
                  </li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- EXPLORER -->
      <div class="tab-pane {{ show_explorer }}" id="explorer_menu">
        <!-- Datasets / Screens / Screen Groups -->
        <div class="row-fluid">
          <div class="span 12">
            <div class="tabbable">
              <!-- Tabs' Header -->
              <ul class="nav nav-tabs">
                <li class="{{ datasets_tab }}"><a href="#datasets_tab" data-toggle="tab">DataSets</a></li>
                <li class="{{ patients_tab }}"><a href="#patients_tab" data-toggle="tab">Patients</a></li>
                <li class="{{ screens_tab }}"><a href="#screens_tab" data-toggle="tab">Screens</a></li>
                <li class="{{ screengroups_tab }}"><a href="#screengroups_tab" data-toggle="tab">Screen Groups</a></li>
              </ul>
              <!-- Tabs' Content -->
              <div class="tab-content">
                <!-- Datasets -->
                <div id="datasets_tab" class="tab-pane {{ show_datasets }}">
                  <div class="row-fluid">
                    <div class="span12">
                      Datasets
                    </div>
                  </div>
                </div>

                <!-- Datasets -->
                <div id="patients_tab" class="tab-pane {{ show_patient }}">
                  <div class="row-fluid">
                    <div class="span12">
                      <table class="table table-striped table-hover" id="main_table">
                        <thead>
                          <tr>
                            <th>ID</th> <th>Identifier</th> <th>Source</th> <th>Organizm</th>
                          </tr>
                        </thead>
                        <tbody id="patients-pagination-content">
                          {% include "paginators/patients-paginator.html" %}
                        </tbody>
                      </table>
                      <p><br>&nbsp;<br></p>
                      <div id="patients-pagination-control"></div>
                    </div>
                  </div>
                </div>

                <!-- Screens -->
                <div id="screens_tab" class="tab-pane {{ show_screens }}">
                  <div class="row-fluid">
                    <div class="span12">
                      <table class="table table-striped table-hover" id="main_table">
                        <thead>
                          <tr>
                            <th>ID</th> <th>Sample Name</th> <th>Screen Name</th> <th>Tissue</th><th>Experiment</th><th>Source</th>
                          </tr>
                        </thead>
                        <tbody id="screens-pagination-content">
                          {% include "paginators/screens-paginator.html" %}
                        </tbody>
                      </table>
                      <p><br>&nbsp;<br></p>
                      <div id="screens-pagination-control"></div>
                    </div>
                  </div>
                </div>
                <!-- Screen Groups -->
                <div id="screengroups_tab" class="tab-pane {{ show_screengroups }}">
                  <div class="row-fluid">
                    <div class="span 12">
                      Groups
                    </div>
                  </div>
                  <p><br>&nbsp;<br></p>
                </div>
              </div> <!-- END of Tabs' Content -->
            </div>
          </div>
        </div>
      </div>
      <!-- PREFERENCES -->
      <div class="tab-pane {{ show_preferences }}" id="preferences_menu">
        <!-- Statistics / Projects / Groups -->
        <div class="row-fluid">
          <div class="span 12">
            <div class="tabbable">
              <!-- Tabs' Header -->
              <ul class="nav nav-tabs">
                <li class="{{ projects_tab }}"><a href="#projects_tab" data-toggle="tab">Projects</a></li>
                <li class="{{ usergroups_tab }}"><a href="#usergroups_tab" data-toggle="tab">User Groups</a></li>
                <li class="{{ statistics_tab }}"><a href="#statistics_tab" data-toggle="tab">Statistics</a></li>
              </ul>
              <!-- Tabs' Content -->
              <div class="tab-content">
                <!-- PROJECTS -->
                <div id="projects_tab" class="tab-pane {{ show_projects }}">
                  <div class="row-fluid">
                    <div class="span12">
                      <!-- PROJECTS: New Project Button  -->
                      <p>
                        <a id="new_project_btn" href="#" class="btn btn-small btn-primary hcalls" type="button" data-toggle="modal"  data-target="#NewProject"  data-param="/projects/create">
                          <i class="icon-plus icon-white"></i><strong>&nbsp;New Project</strong>
                        </a>
                      <p/>
                      <!-- PROJECTS: List -->
                      <table class="table table-striped table-hover" id="main_table">
                        <thead>
                          <tr>
                            <th>Public</th> <th>Name</th> <th>Manager</th> <th>View</th> <th>Edit</th> <th></th><th>Delete</th>
                          </tr>
                        </thead>
                        <tbody id="padination-projects">
                          {% include "projects-paginator.html" %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <!-- GROUPS -->
                <div id="usergroups_tab" class="tab-pane {{ show_usergroups }}">
                  <div class="row-fluid">
                    <div class="span12">
                      <!-- Grous: New Group Button -->
                      <p>
                        <a id="new_group_btn" href="#" class="btn btn-small btn-primary hcalls" type="button" data-toggle="modal"  data-target="#NewGroup"  data-param="/groups/create">
                          <i class="icon-plus icon-white"></i><strong>&nbsp;New Group</strong>
                        </a>
                      </p>
                      <!-- Grous: List -->
                      <table class="table table-striped table-hover" id="main_table">
                        <thead>
                          <tr>
                            <th>Name</th> <th>View</th> <th>Edit</th> <th></th><th>Delete</th>
                          </tr>
                        </thead>
                        <tbody id="padination-groups">
                          {% include "groups-paginator.html" %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <p><br>&nbsp;<br></p>
                </div>
                <!-- DB STATISTICS -->
                <div id="statistics_tab" class="tab-pane {{ show_statistics }}">
                  <div class="row-fluid">
                    <div class="span 12">
                      <table class="table table-bordered table-condensed">
                        <tbody>
                          <tr class="warning"><td>&nbsp; <strong>Jobs running:</strong> <span class="badge badge-info pull-right">{{ dbStat.jobs_running }}</span>&nbsp; </td></tr>
                          <tr class="warning"><td>&nbsp; <strong>Jobs sheduled:</strong> <span class="badge badge-info pull-right">{{ dbStat.jobs_scheduled }}</span>&nbsp; </td></tr>
                          <tr class="warning"><td>&nbsp; <strong>Jobs in history:</strong> <span class="badge badge-info pull-right">{{ dbStat.jobs_history }}</span>&nbsp; </td></tr>
                          <tr class="info"><td>&nbsp; <strong>Scripts in db:</strong> <span class="badge badge-info pull-right">{{ dbStat.scripts_total }}</span>&nbsp; </td></tr>
                          <tr class="info"><td>&nbsp; <strong>Reports in db:</strong> <span class="badge badge-info pull-right">{{ dbStat.scripts_tags }}</span>&nbsp; </td></tr>
                          <tr class="info"><td>&nbsp; <strong>Instances in db:</strong> <span class="badge badge-info pull-right">9999</span>&nbsp; </td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <p><br>&nbsp;<br></p>
                </div>
              </div> <!-- END of Tabs' Content -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- HOUM NOTIFICATION ROW
    <div class="row-fluid">
      <div class="span12 alert alert-info">
        <p><strong>HUOM!</strong></p>
        <p align="justify">
          Please keep in mind that this is a BETA version, so it might be unstable. We strongly advise that you use any other browser
          (<a href="http://www.google.com/chrome/" target="_blank">Google Chrome</a>,
          <a href="http://www.mozilla.org/en-US/firefox/new/" target="_blank">Mozilla Firefox</a>,
          <a href="http://www.apple.com/safari/" target="_blank">Safari</a>) but Microsoft IE so far.

          For BUG Tracking reasons please make use of BREEZE GitHub
          <a href="https://github.com/findcomrade/isbio/issues" target="_blank">Issues Page</a>
          or contact us by dmitrii.bychkov(at)helsinki.fi.
          Any ideas regarding desirable improvements and enhancements are very welcome. Kiitos!
        </p>
      </div>
    </div>
    HOUM NOTIFICATION ROW -->

    <!-- <div id="chart" style="width:100%; height:400px;"></div> -->
  </div>


</div>

<!-- MODALs -->
<div id="NewProject" class="modal hide fade" role="dialog" aria-hidden="true" style="background: url('/static/nail.png');"></div>
<div id="EditProject" class="modal hide fade" role="dialog" aria-hidden="true" style="background: url('/static/nail.png');"></div>
<div id="ProjectInfo" class="modal hide fade" role="dialog" aria-hidden="true" style="background: url('/static/nail.png');"></div>
<div id="NewGroup" class="modal hide fade" role="dialog" aria-hidden="true" style="background: url('/static/nail.png');"></div>
<div id="EditGroup" class="modal hide fade" role="dialog" aria-hidden="true" style="background: url('/static/nail.png');"></div>
<div id="GroupInfo" class="modal hide fade" role="dialog" aria-hidden="true" style="background: url('/static/nail.png');"></div>

<div id="UpdateInfo" class="modal hide fade" role="dialog" aria-hidden="true" style="background: url('/static/nail.png');"></div>

<div id="DeleteItem" class="modal hide fade" role="dialog"  aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
    <h3 id="del_title"> </h3>
  </div>
  <div class="modal-body">
    <p id="del_body"> </p>
  </div>
  <div class="modal-footer">
    <a id="del_item_btn" href="#" class="btn btn-danger" > Delete </a>
    <a href="#" class="btn btn-inverse" data-dismiss="modal" aria-hidden="true">Close</a>
  </div>
</div>

<script type="text/javascript">
  $(document).ready(function(){
    modalConnect();

  // paginator setup
  var pagOptScreens = {
    currentPage: 1,
    numberOfPages:5,
    totalPages: "{{ pag_total_screens }}",
    alignment:'center',
    onPageChanged: function(e,oldPage,newPage){
      //console.log( $('#pagination-test').load('/reports/ #pagination_context', "Page:" + newPage ) );
      $.get("/pagination/home/", { page: newPage, table: 'screens' }, function(data){
        $('#screens-pagination-content').html(data);
      });
    }
  }

  $('#screens-pagination-control').bootstrapPaginator(pagOptScreens);

    // initialize Multiselect plugin
    var multiConfigurationSet = {
      includeSelectAllOption: true,
      enableFiltering: true,
      maxHeight: 450
    };
    $('.multiselect').multiselect(multiConfigurationSet);

    // Load Project Info into a modal via AJAX
    $(".pinfo").click(function(ev) {
      ev.preventDefault();
      var par = $(this).data("param");
      $("#ProjectInfo").load("/projects/view/"+par, function() {
        $(this).modal('show');
      });
      return false;
    });

    // Load Group Info into a modal via AJAX
    $(".ginfo").click(function(ev) {
      ev.preventDefault();
      var par = $(this).data("param");
      $("#GroupInfo").load("/groups/view/"+par, function() {
        $(this).modal('show');
      });
      return false;
    });

  function submitItemModalFormBind(url, modalID){
    $('#form_modal_apply').submit(function(ev){
      // exclude 'multiselect-all' if it was a plugin widget
      $(".multiselect option[value='multiselect-all']").remove();

      var formData = new FormData($('form')[0]);
      $.ajax({
        type: "POST",
        url: url,
        enctype: 'multipart/form-data',
        data: formData,
        success:function(response, textStatus, jqXHR){
          var form = $("#form_modal_apply_div", response);
          // form is returned if it is not valid. update modal with returned form
          // change this "if" to check for a specific return code which should be set in the view
          if ( form.html() ){  //update modal div
            $('#form_modal_apply_div').html(form);

            $('.multiselect').multiselect(multiConfigurationSet);

            $(modalID).modal('show');
          }
          else{  // form is not returned if form submission succeeded
          // update the entire doc with the response, since we received a entire success page and we want to reload the entire page
            document.open();
            document.write(response);
            document.close();
            $(modalID).modal('hide');
          }
        },
        error: function (request, status, error) {
          // implement proper error handling
          // console.log(request.responseText);
        },
        cache: false,
        contentType: false,
        processData: false
      });  // end of $.ajax()

      return false;
    }); // submitItemModalFormBind(url, modalID)
  }

  function modalConnect(){
    // 'hcalls' Class - goes for home ajax callable elements
    var controls = $('.hcalls')  // [ "#update_btn", "#new_project_btn" ]

    $.each(controls, function(i,element){
      $(element).unbind('click');

      $(element).click(function(ev){
        ev.preventDefault();

        var par = $(this).data("param");
        var tar = $(this).data("target");
        $.get(par.toString(), function(results){
          $(tar).html(results);

          $('.multiselect').multiselect(multiConfigurationSet);

          $(tar).modal('show');
          $(document).ready(function(){
            submitItemModalFormBind(url=par.toString(), modalID=tar);
          });

        }, "html");

        return false;
      });

    });

  }
});
</script>
{% endblock %}